-- ============================================================
-- 点差コントロール機能の追加
-- ============================================================
-- 実行日: 2025-11-16
-- 説明: 大会モードで最高点と最低点の点差を制限する機能
-- ============================================================

-- ============================================================
-- 1. sessions テーブルに max_score_diff カラムを追加
-- ============================================================

ALTER TABLE sessions
ADD COLUMN IF NOT EXISTS max_score_diff INTEGER DEFAULT NULL;

-- ============================================================
-- 2. コメントを追加
-- ============================================================

COMMENT ON COLUMN sessions.max_score_diff IS '大会モードでの最大許容点差（整数、NULL=制限なし）';

-- ============================================================
-- 3. 制約を追加（1〜10点の範囲）
-- ============================================================

ALTER TABLE sessions
DROP CONSTRAINT IF EXISTS sessions_max_score_diff_check;

ALTER TABLE sessions
ADD CONSTRAINT sessions_max_score_diff_check
CHECK (max_score_diff IS NULL OR (max_score_diff >= 1 AND max_score_diff <= 10));

-- ============================================================
-- 完了メッセージ
-- ============================================================

DO $$
BEGIN
  RAISE NOTICE '============================================================';
  RAISE NOTICE '点差コントロール機能の追加が完了しました';
  RAISE NOTICE '============================================================';
  RAISE NOTICE '追加されたカラム:';
  RAISE NOTICE '- sessions.max_score_diff (INTEGER, NULL許可)';
  RAISE NOTICE '制約:';
  RAISE NOTICE '- 値は1〜10の範囲、またはNULL（制限なし）';
  RAISE NOTICE '============================================================';
  RAISE NOTICE '使用例:';
  RAISE NOTICE '- max_score_diff = NULL → 点差制限なし（デフォルト）';
  RAISE NOTICE '- max_score_diff = 2 → 点差2点まで許容';
  RAISE NOTICE '- max_score_diff = 3 → 点差3点まで許容';
  RAISE NOTICE '============================================================';
END $$;
