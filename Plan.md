# TENTO ãƒãƒã‚¿ã‚¤ã‚ºå®Ÿè£…è¨ˆç”»

## ğŸ’° æ–™é‡‘ãƒ—ãƒ©ãƒ³

### ãƒ—ãƒ©ãƒ³æ§‹æˆ

**1. ãƒ•ãƒªãƒ¼ãƒ—ãƒ©ãƒ³ï¼ˆç„¡æ–™ï¼‰**

- æœˆé–“3ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¾ã§
- é¸æ‰‹æ•°: 30åã¾ã§/ã‚»ãƒƒã‚·ãƒ§ãƒ³
- æ¤œå®šå“¡: 5åã¾ã§/ã‚»ãƒƒã‚·ãƒ§ãƒ³
- åŸºæœ¬çš„ãªæ¡ç‚¹æ©Ÿèƒ½
- CSV ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
- æ¤œå®šãƒ¢ãƒ¼ãƒ‰ã®ã¿

**2. ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ãƒ—ãƒ©ãƒ³**

- **æœˆé¡: Â¥980/æœˆ**
- **å¹´é¡: Â¥9,800/å¹´ï¼ˆ2ãƒ¶æœˆåˆ†ãŠå¾—ï¼ï¼‰**
- æœˆé–“ç„¡åˆ¶é™ã‚»ãƒƒã‚·ãƒ§ãƒ³
- é¸æ‰‹æ•°: 100åã¾ã§/ã‚»ãƒƒã‚·ãƒ§ãƒ³
- æ¤œå®šå“¡: 20åã¾ã§/ã‚»ãƒƒã‚·ãƒ§ãƒ³
- æ¤œå®šãƒ¢ãƒ¼ãƒ‰ + å¤§ä¼šãƒ¢ãƒ¼ãƒ‰
- ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰å…¬é–‹æ©Ÿèƒ½
- ãƒ¡ãƒ¼ãƒ«ã‚µãƒãƒ¼ãƒˆ
- ãƒ‡ãƒ¼ã‚¿ä¿å­˜æœŸé–“: 1å¹´

**3. ãƒ—ãƒ­ãƒ—ãƒ©ãƒ³**

- **æœˆé¡: Â¥2,980/æœˆ**
- **å¹´é¡: Â¥29,800/å¹´ï¼ˆç´„6ãƒ¶æœˆåˆ†ãŠå¾—ï¼ï¼‰**
- ã™ã¹ã¦ã®ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰æ©Ÿèƒ½
- é¸æ‰‹æ•°: ç„¡åˆ¶é™
- æ¤œå®šå“¡: ç„¡åˆ¶é™
- ãƒ‡ãƒ¼ã‚¿ä¿å­˜æœŸé–“: ç„¡åˆ¶é™
- å„ªå…ˆãƒ¡ãƒ¼ãƒ«ã‚µãƒãƒ¼ãƒˆ

### ä¾¡æ ¼æ¯”è¼ƒè¡¨

| ãƒ—ãƒ©ãƒ³       | æœˆé¡   | å¹´é¡    | å¹´é–“å‰²å¼•é¡                  |
| ------------ | ------ | ------- | --------------------------- |
| ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ | Â¥980   | Â¥9,800  | Â¥1,960ãŠå¾—ï¼ˆ2ãƒ¶æœˆåˆ†ç„¡æ–™ï¼‰   |
| ãƒ—ãƒ­         | Â¥2,980 | Â¥29,800 | Â¥5,960ãŠå¾—ï¼ˆç´„2ãƒ¶æœˆåˆ†ç„¡æ–™ï¼‰ |

### æ©Ÿèƒ½æ¯”è¼ƒè¡¨

| é …ç›®                | ãƒ•ãƒªãƒ¼ | ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ | ãƒ—ãƒ­       |
| ------------------- | ------ | ------------ | ---------- |
| æœˆé–“ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°    | 3      | ç„¡åˆ¶é™       | ç„¡åˆ¶é™     |
| é¸æ‰‹æ•°/ã‚»ãƒƒã‚·ãƒ§ãƒ³   | 30å   | 100å        | **ç„¡åˆ¶é™** |
| æ¤œå®šå“¡æ•°/ã‚»ãƒƒã‚·ãƒ§ãƒ³ | 5å    | 20å         | **ç„¡åˆ¶é™** |
| å¤§ä¼šãƒ¢ãƒ¼ãƒ‰          | âœ—      | âœ“            | âœ“          |
| ç ”ä¿®ãƒ¢ãƒ¼ãƒ‰          | âœ—      | âœ“            | âœ“          |
| ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰        | âœ—      | âœ“            | âœ“          |
| ãƒ‡ãƒ¼ã‚¿ä¿å­˜æœŸé–“      | 3ãƒ¶æœˆ  | 1å¹´          | **ç„¡åˆ¶é™** |

### æƒ³å®šãƒ¦ãƒ¼ã‚¶ãƒ¼

- **ãƒ•ãƒªãƒ¼**: å€‹äººã®æ¤œå®šå“¡ã€å°è¦æ¨¡ãªã‚¯ãƒ©ãƒ–
- **ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰**: ã‚¹ã‚­ãƒ¼ã‚¹ã‚¯ãƒ¼ãƒ«ã€åœ°åŸŸã®å¤§ä¼šé‹å–¶è€…
- **ãƒ—ãƒ­**: å¤§è¦æ¨¡ãªå¤§ä¼šä¸»å‚¬è€…ã€é•·æœŸçš„ãªãƒ‡ãƒ¼ã‚¿ç®¡ç†ãŒå¿…è¦ãªçµ„ç¹”

---

## ğŸ—ï¸ Stripeå®Ÿè£…ã®å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  /pricing                æ–™é‡‘ãƒ—ãƒ©ãƒ³è¡¨ç¤º                        â”‚
â”‚  /account                ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³ãƒ»ä½¿ç”¨çŠ¶æ³è¡¨ç¤º             â”‚
â”‚  /account/billing        è«‹æ±‚å±¥æ­´ãƒ»ã‚«ãƒ¼ãƒ‰å¤‰æ›´                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â†“ APIå‘¼ã³å‡ºã—
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ API                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  POST /api/stripe/create-checkout-session                    â”‚
â”‚    â†’ Stripe Checkoutã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ                            â”‚
â”‚                                                               â”‚
â”‚  POST /api/stripe/create-portal-session                      â”‚
â”‚    â†’ Stripe Customer Portalã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ                     â”‚
â”‚                                                               â”‚
â”‚  POST /api/stripe/webhook                                    â”‚
â”‚    â†’ Stripeã‹ã‚‰ã®ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â†“ Stripe APIå‘¼ã³å‡ºã—
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Stripe                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ Checkout Session (æ±ºæ¸ˆç”»é¢)                               â”‚
â”‚  â€¢ Customer Portal (ã‚µãƒ–ã‚¹ã‚¯ç®¡ç†ç”»é¢)                         â”‚
â”‚  â€¢ Webhooks (ã‚¤ãƒ™ãƒ³ãƒˆé€šçŸ¥)                                    â”‚
â”‚  â€¢ Subscriptions (ã‚µãƒ–ã‚¹ã‚¯ç®¡ç†)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â†“ Webhooké€šçŸ¥
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Supabase DB                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  subscriptions          ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚µãƒ–ã‚¹ã‚¯æƒ…å ±                â”‚
â”‚  usage_limits           ä½¿ç”¨çŠ¶æ³ã®è¿½è·¡                        â”‚
â”‚  plan_limits            ãƒ—ãƒ©ãƒ³åˆ¶é™ã®å®šç¾©                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ è©³ç´°ãªå®Ÿè£…ãƒ•ãƒ­ãƒ¼

### 1ï¸âƒ£ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ—ãƒ©ãƒ³ã‚’é¸æŠã™ã‚‹æµã‚Œ

```
[ãƒ¦ãƒ¼ã‚¶ãƒ¼]
    â†“ /pricing ãƒšãƒ¼ã‚¸ã§ãƒ—ãƒ©ãƒ³ã‚’é¸æŠ
[æ–™é‡‘ãƒšãƒ¼ã‚¸]
    â†“ ã€Œã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã€ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
[ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰]
    â†“ POST /api/stripe/create-checkout-session
[ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰API]
    â†“ 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ç¢ºèª
    â†“ 2. Stripe Customerä½œæˆ/å–å¾—
    â†“ 3. Stripe Checkout Sessionä½œæˆ
    â†“ 4. Checkout URLã‚’è¿”ã™
[ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰]
    â†“ Stripe Checkoutãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
[Stripe Checkout]
    â†“ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚«ãƒ¼ãƒ‰æƒ…å ±å…¥åŠ›ãƒ»æ±ºæ¸ˆ
    â†“ æˆåŠŸæ™‚: /account/success ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
[Stripe]
    â†“ webhook: checkout.session.completed ã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡
[ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰API: Webhook]
    â†“ 1. ã‚¤ãƒ™ãƒ³ãƒˆæ¤œè¨¼
    â†“ 2. subscriptionsãƒ†ãƒ¼ãƒ–ãƒ«ã«ç™»éŒ²
    â†“ 3. ãƒ—ãƒ©ãƒ³æƒ…å ±æ›´æ–°
[å®Œäº†]
```

### 2ï¸âƒ£ ã‚µãƒ–ã‚¹ã‚¯ç®¡ç†ã®æµã‚Œ

```
[ãƒ¦ãƒ¼ã‚¶ãƒ¼]
    â†“ /account ãƒšãƒ¼ã‚¸ã§ã€Œãƒ—ãƒ©ãƒ³ç®¡ç†ã€ã‚¯ãƒªãƒƒã‚¯
[ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒšãƒ¼ã‚¸]
    â†“ POST /api/stripe/create-portal-session
[ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰API]
    â†“ 1. Stripe Customer IDå–å¾—
    â†“ 2. Customer Portal Sessionä½œæˆ
    â†“ 3. Portal URLã‚’è¿”ã™
[ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰]
    â†“ Stripe Customer Portalã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
[Stripe Portal]
    â†“ ãƒ—ãƒ©ãƒ³å¤‰æ›´ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ»ã‚«ãƒ¼ãƒ‰æ›´æ–°
[Stripe]
    â†“ webhook: customer.subscription.* ã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡
[ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰API: Webhook]
    â†“ subscriptionsãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
[å®Œäº†]
```

### 3ï¸âƒ£ åˆ¶é™ãƒã‚§ãƒƒã‚¯ã®æµã‚Œ

```
[ãƒ¦ãƒ¼ã‚¶ãƒ¼]
    â†“ ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
[ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰]
    â†“ POST /session/create
[ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰API]
    â†“ 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ©ãƒ³å–å¾— (subscriptionsãƒ†ãƒ¼ãƒ–ãƒ«)
    â†“ 2. ä»Šæœˆã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°ã‚«ã‚¦ãƒ³ãƒˆ (usage_limitsãƒ†ãƒ¼ãƒ–ãƒ«)
    â†“ 3. ãƒ—ãƒ©ãƒ³åˆ¶é™ã¨æ¯”è¼ƒ (plan_limitsãƒ†ãƒ¼ãƒ–ãƒ«)
    â†“ 4-a. OK â†’ ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
    â†“ 4-b. NG â†’ ã‚¨ãƒ©ãƒ¼ã€Œåˆ¶é™ã«é”ã—ã¾ã—ãŸã€
[å®Œäº†]
```

---

## ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### subscriptions ãƒ†ãƒ¼ãƒ–ãƒ«

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ç®¡ç†

```sql
CREATE TABLE subscriptions (
  id BIGSERIAL PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,

  -- Stripeé–¢é€£
  stripe_customer_id TEXT UNIQUE NOT NULL,
  stripe_subscription_id TEXT UNIQUE,

  -- ãƒ—ãƒ©ãƒ³æƒ…å ±
  plan_type TEXT NOT NULL CHECK (plan_type IN ('free', 'standard', 'pro')),
  billing_interval TEXT NOT NULL CHECK (billing_interval IN ('month', 'year')),

  -- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  status TEXT NOT NULL CHECK (status IN ('active', 'canceled', 'past_due', 'unpaid')),

  -- æœŸé–“
  current_period_start TIMESTAMPTZ,
  current_period_end TIMESTAMPTZ,
  cancel_at_period_end BOOLEAN DEFAULT FALSE,

  -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  UNIQUE(user_id)
);

-- RLSè¨­å®š
ALTER TABLE subscriptions ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own subscription"
  ON subscriptions FOR SELECT
  USING (auth.uid() = user_id);
```

### plan_limits ãƒ†ãƒ¼ãƒ–ãƒ«

å„ãƒ—ãƒ©ãƒ³ã®åˆ¶é™å€¤ã‚’å®šç¾©

```sql
CREATE TABLE plan_limits (
  plan_type TEXT PRIMARY KEY,
  max_sessions_per_month INTEGER, -- -1 = unlimited
  max_athletes_per_session INTEGER,
  max_judges_per_session INTEGER,
  has_tournament_mode BOOLEAN DEFAULT FALSE,
  has_training_mode BOOLEAN DEFAULT FALSE,
  has_scoreboard BOOLEAN DEFAULT FALSE,
  data_retention_months INTEGER -- -1 = unlimited
);

INSERT INTO plan_limits VALUES
  ('free', 3, 30, 5, false, false, false, 3),
  ('standard', -1, 100, 20, true, true, true, 12),
  ('pro', -1, -1, -1, true, true, true, -1);
```

### usage_limits ãƒ†ãƒ¼ãƒ–ãƒ«

æœˆã”ã¨ã®ä½¿ç”¨çŠ¶æ³ã‚’è¿½è·¡

```sql
CREATE TABLE usage_limits (
  id BIGSERIAL PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  month DATE NOT NULL, -- 'YYYY-MM-01' å½¢å¼
  sessions_count INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(user_id, month)
);

-- RLSè¨­å®š
ALTER TABLE usage_limits ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own usage"
  ON usage_limits FOR SELECT
  USING (auth.uid() = user_id);
```

---

## ğŸ” Stripe Webhook ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†

### å‡¦ç†ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§

#### 1. checkout.session.completed

- **ã‚¿ã‚¤ãƒŸãƒ³ã‚°**: æ–°è¦ã‚µãƒ–ã‚¹ã‚¯ç™»éŒ²æˆåŠŸæ™‚
- **å‡¦ç†å†…å®¹**: `subscriptions`ãƒ†ãƒ¼ãƒ–ãƒ«ã«æ–°è¦ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆ

#### 2. customer.subscription.created

- **ã‚¿ã‚¤ãƒŸãƒ³ã‚°**: ã‚µãƒ–ã‚¹ã‚¯ä½œæˆæ™‚ï¼ˆcheckoutã®å¾Œã«æ¥ã‚‹ï¼‰
- **å‡¦ç†å†…å®¹**: å¿…è¦ã«å¿œã˜ã¦ãƒ¬ã‚³ãƒ¼ãƒ‰æ›´æ–°

#### 3. customer.subscription.updated

- **ã‚¿ã‚¤ãƒŸãƒ³ã‚°**: ãƒ—ãƒ©ãƒ³å¤‰æ›´æ™‚ï¼ˆstandard â†’ pro ãªã©ï¼‰
- **å‡¦ç†å†…å®¹**: `plan_type`, `billing_interval`ã‚’æ›´æ–°

#### 4. customer.subscription.deleted

- **ã‚¿ã‚¤ãƒŸãƒ³ã‚°**: ã‚µãƒ–ã‚¹ã‚¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚
- **å‡¦ç†å†…å®¹**:
  - `status`ã‚’'canceled'ã«æ›´æ–°
  - `plan_type`ã‚’'free'ã«é™æ ¼

#### 5. invoice.payment_succeeded

- **ã‚¿ã‚¤ãƒŸãƒ³ã‚°**: æ›´æ–°æ™‚ã®æ”¯æ‰•ã„æˆåŠŸ
- **å‡¦ç†å†…å®¹**: `current_period_start`, `current_period_end`ã‚’æ›´æ–°

#### 6. invoice.payment_failed

- **ã‚¿ã‚¤ãƒŸãƒ³ã‚°**: æ”¯æ‰•ã„å¤±æ•—
- **å‡¦ç†å†…å®¹**:
  - `status`ã‚’'past_due'ã«æ›´æ–°
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ¡ãƒ¼ãƒ«é€šçŸ¥

---

## ğŸ”§ API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè©³ç´°

### POST /api/stripe/create-checkout-session

Stripe Checkoutã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã€æ±ºæ¸ˆãƒšãƒ¼ã‚¸URLã‚’è¿”ã™

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:**

```typescript
{
  priceId: string, // Stripe Price ID (ä¾‹: price_xxxxx)
  successUrl: string, // æˆåŠŸæ™‚ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURL
  cancelUrl: string  // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURL
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹:**

```typescript
{
	url: string; // Stripe Checkout URL
}
```

**å‡¦ç†å†…å®¹:**

1. ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ç¢ºèª
2. Stripe Customerä½œæˆ/å–å¾—
3. Checkout Sessionä½œæˆ
4. URLã‚’è¿”ã™

---

### POST /api/stripe/create-portal-session

Stripe Customer Portalã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆ

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:**

```typescript
{
	returnUrl: string; // Portalçµ‚äº†å¾Œã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURL
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹:**

```typescript
{
	url: string; // Stripe Customer Portal URL
}
```

**å‡¦ç†å†…å®¹:**

1. ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ç¢ºèª
2. `subscriptions`ã‹ã‚‰Customer IDå–å¾—
3. Portal Sessionä½œæˆ
4. URLã‚’è¿”ã™

---

### POST /api/stripe/webhook

Stripeã‹ã‚‰ã®webhookã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ä¿¡ãƒ»å‡¦ç†

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:**

- Stripeã‹ã‚‰ã®webhookã‚¤ãƒ™ãƒ³ãƒˆï¼ˆç½²åä»˜ãï¼‰

**å‡¦ç†å†…å®¹:**

1. Stripeç½²åæ¤œè¨¼
2. ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦å‡¦ç†
3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–°
4. 200 OKã‚’è¿”ã™

---

## ğŸ¨ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç”»é¢è¨­è¨ˆ

### /pricing ãƒšãƒ¼ã‚¸

æ–™é‡‘ãƒ—ãƒ©ãƒ³æ¯”è¼ƒã¨ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ–™é‡‘ãƒ—ãƒ©ãƒ³                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚  [ãƒ•ãƒªãƒ¼]    [ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰]    [ãƒ—ãƒ­]        â”‚
â”‚   Â¥0         Â¥980/æœˆ          Â¥2,980/æœˆ    â”‚
â”‚              Â¥9,800/å¹´        Â¥29,800/å¹´   â”‚
â”‚                                             â”‚
â”‚  â€¢ 3ã‚»ãƒƒã‚·ãƒ§ãƒ³  â€¢ ç„¡åˆ¶é™ã‚»ãƒƒã‚·ãƒ§ãƒ³  â€¢ ç„¡åˆ¶é™  â”‚
â”‚  â€¢ 30é¸æ‰‹      â€¢ 100é¸æ‰‹         â€¢ ç„¡åˆ¶é™  â”‚
â”‚  â€¢ 5æ¤œå®šå“¡     â€¢ 20æ¤œå®šå“¡        â€¢ ç„¡åˆ¶é™  â”‚
â”‚                                             â”‚
â”‚              [ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰]  [ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### /account ãƒšãƒ¼ã‚¸

ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³ãƒ»ä½¿ç”¨çŠ¶æ³ãƒ»ç®¡ç†ãƒœã‚¿ãƒ³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚  ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³: ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ (æœˆé¡)             â”‚
â”‚  æ¬¡å›æ›´æ–°æ—¥: 2025-12-01                      â”‚
â”‚                                             â”‚
â”‚  [ãƒ—ãƒ©ãƒ³ç®¡ç†] [è«‹æ±‚å±¥æ­´]                      â”‚
â”‚                                             â”‚
â”‚  ä»Šæœˆã®ä½¿ç”¨çŠ¶æ³:                              â”‚
â”‚  â”â”â”â”â”â”â”â”â”â” 5 / ç„¡åˆ¶é™ ã‚»ãƒƒã‚·ãƒ§ãƒ³           â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–

### 1. Webhookç½²åæ¤œè¨¼å¿…é ˆ

- Stripeã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã¿å—ã‘ä»˜ã‘ã‚‹
- ç½²åãŒä¸€è‡´ã—ãªã„å ´åˆã¯403ã‚¨ãƒ©ãƒ¼

### 2. ç’°å¢ƒå¤‰æ•°ã®åˆ†é›¢

- ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰/æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ã®APIã‚­ãƒ¼ã‚’åˆ†ã‘ã‚‹
- `.env.local`ã«ãƒ†ã‚¹ãƒˆç”¨ã‚­ãƒ¼
- Vercelã®ç’°å¢ƒå¤‰æ•°ã«æœ¬ç•ªç”¨ã‚­ãƒ¼

### 3. RLS (Row Level Security)

- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®ã‚µãƒ–ã‚¹ã‚¯æƒ…å ±ã®ã¿å‚ç…§å¯èƒ½
- auth.uid()ã‚’ä½¿ç”¨ã—ãŸãƒãƒªã‚·ãƒ¼è¨­å®š

### 4. HTTPSå¿…é ˆ

- Webhookã¯å¿…ãšHTTPSã§å—ä¿¡
- ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºæ™‚ã¯Stripe CLIã‚’ä½¿ç”¨

---

## ğŸ“ å¿…è¦ãªç’°å¢ƒå¤‰æ•°

### é–‹ç™ºç’°å¢ƒ (.env.local)

```env
# Stripe Test Mode
STRIPE_SECRET_KEY=sk_test_xxxxx
STRIPE_PUBLISHABLE_KEY=pk_test_xxxxx
STRIPE_WEBHOOK_SECRET=whsec_xxxxx
```

### æœ¬ç•ªç’°å¢ƒ (Vercelç’°å¢ƒå¤‰æ•°)

```env
# Stripe Live Mode
STRIPE_SECRET_KEY=sk_live_xxxxx
STRIPE_PUBLISHABLE_KEY=pk_live_xxxxx
STRIPE_WEBHOOK_SECRET=whsec_xxxxx
```

---

## ğŸ—ºï¸ å®Ÿè£…ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—

### ãƒ•ã‚§ãƒ¼ã‚º1: åŸºç›¤æ§‹ç¯‰ï¼ˆ1-2é€±é–“ï¼‰

#### 1.1 Stripe ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

- [ ] Stripeã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ
- [ ] ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰/æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ã®ç’°å¢ƒå¤‰æ•°è¨­å®š
- [ ] Stripe CLI ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

#### 1.2 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒæ‹¡å¼µ

- [ ] `subscriptions` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] `plan_limits` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] `usage_limits` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] RLSãƒãƒªã‚·ãƒ¼è¨­å®š

#### 1.3 ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ APIæ§‹ç¯‰

- [ ] `/api/stripe/create-checkout-session` å®Ÿè£…
- [ ] `/api/stripe/create-portal-session` å®Ÿè£…
- [ ] `/api/stripe/webhook` å®Ÿè£…

### ãƒ•ã‚§ãƒ¼ã‚º2: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…ï¼ˆ1é€±é–“ï¼‰

#### 2.1 æ–™é‡‘ãƒšãƒ¼ã‚¸ä½œæˆ

- [ ] `/pricing` ãƒšãƒ¼ã‚¸ä½œæˆ
- [ ] ãƒ—ãƒ©ãƒ³æ¯”è¼ƒè¡¨ã®å®Ÿè£…
- [ ] "ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰" ãƒœã‚¿ãƒ³å®Ÿè£…

#### 2.2 ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒšãƒ¼ã‚¸æ‹¡å¼µ

- [ ] ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³è¡¨ç¤º
- [ ] ä½¿ç”¨çŠ¶æ³è¡¨ç¤ºï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°ãªã©ï¼‰
- [ ] ãƒ—ãƒ©ãƒ³å¤‰æ›´ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³

#### 2.3 åˆ¶é™ãƒã‚§ãƒƒã‚¯å®Ÿè£…

- [ ] ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆæ™‚ã®åˆ¶é™ãƒã‚§ãƒƒã‚¯
- [ ] å‚åŠ è€…è¿½åŠ æ™‚ã®åˆ¶é™ãƒã‚§ãƒƒã‚¯
- [ ] å¤§ä¼šãƒ¢ãƒ¼ãƒ‰ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™

### ãƒ•ã‚§ãƒ¼ã‚º3: Webhook & åŒæœŸï¼ˆ1é€±é–“ï¼‰

#### 3.1 Stripe Webhookå‡¦ç†

- [ ] `checkout.session.completed` ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
- [ ] `customer.subscription.updated` ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
- [ ] `customer.subscription.deleted` ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
- [ ] `invoice.payment_succeeded` ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
- [ ] `invoice.payment_failed` ãƒãƒ³ãƒ‰ãƒ©ãƒ¼

#### 3.2 è‡ªå‹•æ›´æ–°å‡¦ç†

- [ ] ã‚µãƒ–ã‚¹ã‚¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è‡ªå‹•æ›´æ–°
- [ ] æœŸé™åˆ‡ã‚Œæ™‚ã®åˆ¶é™é©ç”¨
- [ ] ãƒ¡ãƒ¼ãƒ«é€šçŸ¥

### ãƒ•ã‚§ãƒ¼ã‚º4: ãƒ†ã‚¹ãƒˆ & æœ¬ç•ªåŒ–ï¼ˆ1é€±é–“ï¼‰

#### 4.1 ãƒ†ã‚¹ãƒˆ

- [ ] Stripeãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§ã®æ±ºæ¸ˆãƒ•ãƒ­ãƒ¼ç¢ºèª
- [ ] Webhookå‹•ä½œç¢ºèª
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ç¢ºèª
- [ ] åˆ¶é™æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ

#### 4.2 æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤

- [ ] æœ¬ç•ªStripe APIã‚­ãƒ¼è¨­å®š
- [ ] ç‰¹å®šå•†å–å¼•æ³•è¡¨ç¤ºãƒšãƒ¼ã‚¸
- [ ] ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼æ›´æ–°
- [ ] åˆ©ç”¨è¦ç´„ä½œæˆ

---

## ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚³ã‚¹ãƒˆã®è©¦ç®—

### Supabaseã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚³ã‚¹ãƒˆ

**ç„¡æ–™æ :**

- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å®¹é‡: 500MB
- ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸: 1GB

**Pro ãƒ—ãƒ©ãƒ³ï¼ˆ$25/æœˆ = ç´„Â¥3,500ï¼‰:**

- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å®¹é‡: 8GB
- ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸: 100GB
- è¿½åŠ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å®¹é‡: $0.125/GB/æœˆ

### TENTOã®ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºè©¦ç®—

1ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚ãŸã‚Šã®ãƒ‡ãƒ¼ã‚¿é‡ï¼š

- ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±: ~1KB
- å‚åŠ è€…ï¼ˆæ¤œå®šå“¡ï¼‰: ~0.5KB Ã— å¹³å‡10å = 5KB
- é¸æ‰‹æƒ…å ±: ~1KB Ã— å¹³å‡50å = 50KB
- æ¡ç‚¹çµæœ: ~0.5KB Ã— å¹³å‡500ä»¶ = 250KB
- å¤§ä¼šã®ç¨®ç›®è¨­å®š: ~2KB

**åˆè¨ˆ: ç´„300KB/ã‚»ãƒƒã‚·ãƒ§ãƒ³**

### å¹´é–“ã‚³ã‚¹ãƒˆè©¦ç®—

**ãƒ—ãƒ­ãƒ—ãƒ©ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ100åã®å ´åˆ:**

- 1ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚ãŸã‚Šå¹´é–“50ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ³å®š
- ãƒ‡ãƒ¼ã‚¿é‡: 300KB Ã— 50ã‚»ãƒƒã‚·ãƒ§ãƒ³ Ã— 100ãƒ¦ãƒ¼ã‚¶ãƒ¼ = 1.5GB/å¹´

**5å¹´é–“ã®ãƒ‡ãƒ¼ã‚¿è“„ç©:**

- 1.5GB Ã— 5å¹´ = 7.5GB
- Supabase Pro ãƒ—ãƒ©ãƒ³å†…ã§åã¾ã‚‹

**çµè«–:**

- ãƒ‡ãƒ¼ã‚¿ã‚³ã‚¹ãƒˆã¯1ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚ãŸã‚Šæœˆæ•°å††ç¨‹åº¦
- Â¥2,980/æœˆã®ä¾¡æ ¼è¨­å®šã§ååˆ†ãªåˆ©ç›Šç‡ã‚’ç¢ºä¿å¯èƒ½

---

## ğŸ“ ã‚µãƒãƒ¼ãƒˆ

### ãƒ¡ãƒ¼ãƒ«ã‚µãƒãƒ¼ãƒˆ

- ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰: å–¶æ¥­æ—¥48æ™‚é–“ä»¥å†…ã«è¿”ä¿¡
- ãƒ—ãƒ­: å–¶æ¥­æ—¥24æ™‚é–“ä»¥å†…ã«è¿”ä¿¡ï¼ˆå„ªå…ˆå¯¾å¿œï¼‰

### ã‚µãƒãƒ¼ãƒˆå¯¾è±¡

- ä½¿ã„æ–¹ã«é–¢ã™ã‚‹è³ªå•
- ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
- æ©Ÿèƒ½ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
- ãƒã‚°ãƒ¬ãƒãƒ¼ãƒˆ

---

## âš ï¸ å®Ÿè£…æ™‚ã®é‡è¦ãªæ³¨æ„äº‹é …

### ğŸ”´ æœ€é‡è¦: ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã‹ã‚‰å§‹ã‚ã‚‹

**çµ¶å¯¾ã«ã„ããªã‚Šæœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ã§å§‹ã‚ãªã„ã“ã¨ï¼**

- ã¾ãšStripeã®ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§å…¨æ©Ÿèƒ½ã‚’å®Ÿè£…ãƒ»ãƒ†ã‚¹ãƒˆ
- ãƒ†ã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ç•ªå·ã‚’ä½¿ç”¨ã—ã¦æ±ºæ¸ˆãƒ•ãƒ­ãƒ¼ã‚’ç¢ºèª
- Webhookã®å‹•ä½œã‚’å®Œå…¨ã«æ¤œè¨¼ã—ã¦ã‹ã‚‰æœ¬ç•ªåŒ–

---

### ğŸ’³ Stripeã®æ³¨æ„ç‚¹

#### 1. Webhookç½²åæ¤œè¨¼ã¯å¿…é ˆ

**âŒ æ‚ªã„ä¾‹: ç½²åæ¤œè¨¼ãªã—**

```typescript
const event = request.body;
```

**âœ… è‰¯ã„ä¾‹: ç½²åæ¤œè¨¼ã‚ã‚Š**

```typescript
const signature = request.headers['stripe-signature'];
const event = stripe.webhooks.constructEvent(request.body, signature, webhookSecret);
```

**ç†ç”±**: ç½²åæ¤œè¨¼ãŒãªã„ã¨ã€æ‚ªæ„ã®ã‚ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ”¹ã–ã‚“ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

#### 2. Webhookã®ã¹ãç­‰æ€§ã‚’ä¿è¨¼

```typescript
// âœ… åŒã˜ã‚¤ãƒ™ãƒ³ãƒˆãŒè¤‡æ•°å›é€ã‚‰ã‚Œã¦ã‚‚å®‰å…¨
const existingSubscription = await supabase
	.from('subscriptions')
	.select()
	.eq('stripe_subscription_id', subscriptionId)
	.single();

if (existingSubscription) {
	// æ—¢ã«å‡¦ç†æ¸ˆã¿ â†’ ã‚¹ã‚­ãƒƒãƒ—
	return { received: true };
}
```

**ç†ç”±**: Stripeã¯åŒã˜webhookã‚¤ãƒ™ãƒ³ãƒˆã‚’è¤‡æ•°å›é€ä¿¡ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

#### 3. Webhook URLã¯HTTPSå¿…é ˆ

- **ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™º**: `stripe listen --forward-to localhost:5173/api/stripe/webhook`
- **æœ¬ç•ª**: `https://your-domain.com/api/stripe/webhook`

**ç†ç”±**: HTTPã§ã¯StripeãŒWebhookã‚’é€ä¿¡ã§ãã¾ã›ã‚“ã€‚

#### 4. Customer IDã®ç®¡ç†

```typescript
// âœ… ä¸€åº¦ä½œæˆã—ãŸã‚‰å†åˆ©ç”¨
let customerId = user.stripe_customer_id;

if (!customerId) {
	const customer = await stripe.customers.create({
		email: user.email,
		metadata: { user_id: user.id }
	});
	customerId = customer.id;

	// DBã«ä¿å­˜
	await supabase.from('subscriptions').upsert({ user_id: user.id, stripe_customer_id: customerId });
}
```

**ç†ç”±**: åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§è¤‡æ•°ã®Customerã‚’ä½œã‚‹ã¨ç®¡ç†ãŒè¤‡é›‘ã«ãªã‚Šã¾ã™ã€‚

---

### ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ³¨æ„ç‚¹

#### 1. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†

**âŒ å±é™º: é€”ä¸­ã§å¤±æ•—ã™ã‚‹ã¨ä¸æ•´åˆãŒç™ºç”Ÿ**

```typescript
await supabase.from('subscriptions').update(...);
await supabase.from('usage_limits').insert(...);
```

**âœ… å®‰å…¨: RPCã§ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†**

```typescript
await supabase.rpc('update_subscription_and_usage', { ... });
```

#### 2. RLS (Row Level Security)ã®è¨­å®šãƒŸã‚¹

**âŒ å±é™º: å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä»–äººã®ãƒ‡ãƒ¼ã‚¿ã‚’è¦‹ã‚Œã‚‹**

```sql
CREATE POLICY "Anyone can view subscriptions"
  ON subscriptions FOR SELECT
  USING (true);
```

**âœ… å®‰å…¨: è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿**

```sql
CREATE POLICY "Users can view own subscription"
  ON subscriptions FOR SELECT
  USING (auth.uid() = user_id);
```

#### 3. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®è¨­å®š

```sql
-- é »ç¹ã«æ¤œç´¢ã•ã‚Œã‚‹ã‚«ãƒ©ãƒ ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_subscriptions_user_id ON subscriptions(user_id);
CREATE INDEX idx_subscriptions_stripe_customer_id ON subscriptions(stripe_customer_id);
CREATE INDEX idx_usage_limits_user_month ON usage_limits(user_id, month);
```

**ç†ç”±**: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒãªã„ã¨ã‚¯ã‚¨ãƒªãŒé…ããªã‚Šã¾ã™ã€‚

---

### ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®æ³¨æ„ç‚¹

#### 1. ç’°å¢ƒå¤‰æ•°ã®ç®¡ç†

**âŒ å±é™º: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§Secret Keyã‚’ä½¿ç”¨**

```typescript
const stripe = new Stripe(process.env.STRIPE_SECRET_KEY); // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰
```

**âœ… å®‰å…¨: ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®ã¿ã§Secret Keyä½¿ç”¨**

```typescript
// +page.server.ts ã¾ãŸã¯ api/+server.ts ã®ã¿
const stripe = new Stripe(process.env.STRIPE_SECRET_KEY);
```

#### 2. Price IDã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°

**âŒ ä¿å®ˆæ€§ãŒä½ã„**

```typescript
if (plan === 'standard') {
	priceId = 'price_abc123';
}
```

**âœ… ç’°å¢ƒå¤‰æ•°ã§ç®¡ç†**

```typescript
priceId = process.env[`STRIPE_PRICE_${plan.toUpperCase()}_${interval.toUpperCase()}`];
```

#### 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã®ãƒã‚§ãƒƒã‚¯

**âŒ å±é™º: èªè¨¼ãªã—ã§APIå®Ÿè¡Œ**

```typescript
export async function POST({ request }) {
	const { priceId } = await request.json();
	// ...
}
```

**âœ… å®‰å…¨: å¿…ãšèªè¨¼ç¢ºèª**

```typescript
export async function POST({ request, locals: { supabase } }) {
	const {
		data: { user },
		error
	} = await supabase.auth.getUser();

	if (error || !user) {
		throw error(401, 'èªè¨¼ãŒå¿…è¦ã§ã™');
	}
	// ...
}
```

---

### ğŸ¯ ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®æ³¨æ„ç‚¹

#### 1. ãƒ—ãƒ©ãƒ³åˆ¶é™ã®ãƒã‚§ãƒƒã‚¯ã‚¿ã‚¤ãƒŸãƒ³ã‚°

```typescript
// âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆå‰ã«å¿…ãšãƒã‚§ãƒƒã‚¯
export const actions = {
	create: async ({ request, locals: { supabase } }) => {
		const user = await getUser();

		// 1. ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³å–å¾—
		const { plan_type } = await getSubscription(user.id);

		// 2. åˆ¶é™ãƒã‚§ãƒƒã‚¯
		const canCreate = await checkSessionLimit(user.id, plan_type);

		if (!canCreate) {
			return fail(403, {
				error: 'æœˆé–“ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°ã®ä¸Šé™ã«é”ã—ã¦ã„ã¾ã™ã€‚ãƒ—ãƒ©ãƒ³ã‚’ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚'
			});
		}

		// 3. ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
		await createSession();
	}
};
```

#### 2. ã‚°ãƒ¬ãƒ¼ã‚¹ãƒ”ãƒªã‚ªãƒ‰ã®è€ƒæ…®

```typescript
// æ”¯æ‰•ã„å¤±æ•—å¾Œã‚‚æ•°æ—¥é–“ã¯ä½¿ç”¨å¯èƒ½ã«ã™ã‚‹
const isActive =
	subscription.status === 'active' ||
	(subscription.status === 'past_due' && daysSince(subscription.current_period_end) < 3);
```

#### 3. ãƒ—ãƒ©ãƒ³ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰æ™‚ã®å‡¦ç†

```typescript
// Pro â†’ Standard: æ—¢å­˜ã®å¤§è¦æ¨¡ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã©ã†ã™ã‚‹ï¼Ÿ
if (newPlan === 'standard' && oldPlan === 'pro') {
	const largeSessions = await getSessionsOverLimit(userId, 100);

	if (largeSessions.length > 0) {
		// è­¦å‘Šã‚’è¡¨ç¤º
		return fail(400, {
			error: '100åã‚’è¶…ãˆã‚‹ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã—ã¾ã™ã€‚å‰Šé™¤ã¾ãŸã¯ãƒ—ãƒ­ãƒ—ãƒ©ãƒ³ã‚’ç¶­æŒã—ã¦ãã ã•ã„ã€‚'
		});
	}
}
```

---

### ğŸ“± UXã®æ³¨æ„ç‚¹

#### 1. ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®ç®¡ç†

```svelte
<script>
	let loading = false;

	async function handleUpgrade() {
		loading = true;
		try {
			const response = await fetch('/api/stripe/create-checkout-session', {
				method: 'POST',
				body: JSON.stringify({ priceId })
			});
			const { url } = await response.json();
			window.location.href = url;
		} catch (error) {
			alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
		} finally {
			loading = false;
		}
	}
</script>

<button on:click={handleUpgrade} disabled={loading}>
	{loading ? 'å‡¦ç†ä¸­...' : 'ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰'}
</button>
```

#### 2. ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º

**âŒ æŠ€è¡“çš„ãªã‚¨ãƒ©ãƒ¼ã‚’ãã®ã¾ã¾è¡¨ç¤º**

```typescript
throw error(500, stripeError.message);
```

**âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**

```typescript
throw error(500, 'æ±ºæ¸ˆå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
```

#### 3. ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå¾Œã®çŠ¶æ…‹ç®¡ç†

```svelte
<!-- /account/success -->
<script>
	import { onMount } from 'svelte';

	onMount(() => {
		// WebhookãŒå‡¦ç†ã•ã‚Œã‚‹ã¾ã§å°‘ã—å¾…ã¤
		setTimeout(() => {
			window.location.href = '/account';
		}, 2000);
	});
</script>

<div>
	<h1>ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å®Œäº†ï¼</h1>
	<p>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™...</p>
</div>
```

---

### ğŸ§ª ãƒ†ã‚¹ãƒˆã®æ³¨æ„ç‚¹

#### 1. ãƒ†ã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ã®ä½¿ç”¨

```
æˆåŠŸ: 4242 4242 4242 4242
å¤±æ•—: 4000 0000 0000 0002
3Dã‚»ã‚­ãƒ¥ã‚¢: 4000 0025 0000 3155
```

æœ‰åŠ¹æœŸé™: å°†æ¥ã®ä»»æ„ã®æ—¥ä»˜
CVC: ä»»æ„ã®3æ¡

#### 2. Webhook ãƒ†ã‚¹ãƒˆ

```bash
# Stripe CLIã§ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆ
stripe listen --forward-to localhost:5173/api/stripe/webhook

# ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ‰‹å‹•é€ä¿¡
stripe trigger checkout.session.completed
stripe trigger customer.subscription.updated
stripe trigger invoice.payment_failed
```

#### 3. ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã®ãƒ†ã‚¹ãƒˆ

- [ ] æ”¯æ‰•ã„å¤±æ•—æ™‚ã®æŒ™å‹•
- [ ] ãƒ—ãƒ©ãƒ³å¤‰æ›´ä¸­ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
- [ ] åŒæ™‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆç«¶åˆçŠ¶æ…‹ï¼‰
- [ ] Webhooké…å»¶æ™‚ã®æŒ™å‹•
- [ ] ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼æ™‚ã®å†è©¦è¡Œ
- [ ] æœŸé™åˆ‡ã‚Œç›´å¾Œã®ã‚¢ã‚¯ã‚»ã‚¹

---

### ğŸ’° ä¾¡æ ¼è¨­å®šã®æ³¨æ„ç‚¹

#### 1. Stripeæ‰‹æ•°æ–™ã‚’è€ƒæ…®

**æ—¥æœ¬ã®æ‰‹æ•°æ–™: 3.6% + Â¥0**

ä¾‹: Â¥980/æœˆã®å ´åˆ

- Stripeæ‰‹æ•°æ–™: Â¥36 (Â¥980 Ã— 3.6% + Â¥0)
- å®Ÿè³ªåç›Š: Â¥944

ä¾‹: Â¥2,980/æœˆã®å ´åˆ

- Stripeæ‰‹æ•°æ–™: Â¥108
- å®Ÿè³ªåç›Š: Â¥2,872

#### 2. ç¨é‡‘ã®å‡¦ç†

```typescript
// Stripe Tax ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆï¼ˆæ—¥æœ¬ã®æ¶ˆè²»ç¨ï¼‰
const session = await stripe.checkout.sessions.create({
	automatic_tax: { enabled: true }
	// ...
});
```

**æ³¨æ„**: äº‹æ¥­è€…ç™»éŒ²ãŒå¿…è¦ãªå ´åˆãŒã‚ã‚Šã¾ã™ã€‚

---

### ğŸ“ æ³•çš„å¯¾å¿œã®æ³¨æ„ç‚¹

#### å¿…è¦ãªãƒšãƒ¼ã‚¸

**1. ç‰¹å®šå•†å–å¼•æ³•ã«åŸºã¥ãè¡¨è¨˜**

- äº‹æ¥­è€…å
- ä»£è¡¨è€…å
- ä½æ‰€
- é€£çµ¡å…ˆï¼ˆé›»è©±ç•ªå·ãƒ»ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼‰
- è²©å£²ä¾¡æ ¼
- æ”¯æ‰•æ–¹æ³•
- æ”¯æ‰•æ™‚æœŸ
- ã‚µãƒ¼ãƒ“ã‚¹æä¾›æ™‚æœŸ
- è¿”é‡‘ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒãƒªã‚·ãƒ¼

**2. åˆ©ç”¨è¦ç´„**

- ã‚µãƒ¼ãƒ“ã‚¹å†…å®¹ã®å®šç¾©
- æ–™é‡‘ã¨æ”¯æ‰•ã„
- ç„¡æ–™ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰
- ãƒ—ãƒ©ãƒ³å¤‰æ›´ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«
- è¿”é‡‘ãƒãƒªã‚·ãƒ¼
- ç¦æ­¢äº‹é …
- å…è²¬äº‹é …
- æº–æ‹ æ³•

**3. ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼**

- å€‹äººæƒ…å ±ã®å–ã‚Šæ‰±ã„
- Stripeã¸ã®ãƒ‡ãƒ¼ã‚¿æä¾›ã«ã¤ã„ã¦
- ã‚¯ãƒƒã‚­ãƒ¼ã®ä½¿ç”¨
- ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜æœŸé–“
- ãŠå•ã„åˆã‚ã›å…ˆ

#### è¿”é‡‘ãƒãƒªã‚·ãƒ¼ã®ä¾‹

```
è¿”é‡‘ã«ã¤ã„ã¦:
- æœˆé¡ãƒ—ãƒ©ãƒ³ã¯æ—¥å‰²ã‚Šè¿”é‡‘ãªã—
- å¹´é¡ãƒ—ãƒ©ãƒ³ã¯æœªä½¿ç”¨æœˆæ•°åˆ†ã‚’æ—¥å‰²ã‚Šè¨ˆç®—ã§è¿”é‡‘
- ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¾Œã‚‚ç¾åœ¨ã®è«‹æ±‚æœŸé–“çµ‚äº†ã¾ã§ä½¿ç”¨å¯èƒ½
- ã‚·ã‚¹ãƒ†ãƒ éšœå®³ã«ã‚ˆã‚‹é•·æœŸé–“ã®åˆ©ç”¨ä¸å¯ã¯å…¨é¡è¿”é‡‘
```

---

### ğŸš€ å®Ÿè£…é–‹å§‹å‰ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

#### æº–å‚™

- [ ] Stripeã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆï¼ˆãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼‰
- [ ] Stripe CLIã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (`brew install stripe/stripe-cli/stripe`)
- [ ] ç’°å¢ƒå¤‰æ•°ã®æº–å‚™ï¼ˆ.env.localï¼‰
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
- [ ] Plan.mdã®ç¢ºèª

#### æ³•çš„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [ ] ç‰¹å®šå•†å–å¼•æ³•ãƒšãƒ¼ã‚¸ã®ãƒ‰ãƒ©ãƒ•ãƒˆä½œæˆ
- [ ] åˆ©ç”¨è¦ç´„ã®ãƒ‰ãƒ©ãƒ•ãƒˆä½œæˆ
- [ ] ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã®æ›´æ–°
- [ ] è¿”é‡‘ãƒãƒªã‚·ãƒ¼ã®æ±ºå®š

#### ãƒ†ã‚¹ãƒˆè¨ˆç”»

- [ ] ãƒ†ã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ã§æ±ºæ¸ˆãƒ•ãƒ­ãƒ¼ã®ç¢ºèªè¨ˆç”»
- [ ] Webhookå‹•ä½œç¢ºèªã®æ‰‹é †æ›¸
- [ ] ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã®ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª
- [ ] æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤å‰ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

#### Stripeè¨­å®š

- [ ] å•†å“ï¼ˆProductï¼‰ã®ä½œæˆ
- [ ] ä¾¡æ ¼ï¼ˆPriceï¼‰ã®ä½œæˆï¼ˆæœˆé¡4ç¨®ã€å¹´é¡2ç¨®ï¼‰
- [ ] Webhook ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ç™»éŒ²
- [ ] Customer Portalã®è¨­å®š

---

### ğŸ” ãƒ‡ãƒãƒƒã‚°ã®ãƒ’ãƒ³ãƒˆ

#### 1. Webhook ãŒå±Šã‹ãªã„å ´åˆ

**ç¢ºèªãƒã‚¤ãƒ³ãƒˆ:**

- Webhook URLãŒæ­£ã—ã„ã‹
- HTTPSã«ãªã£ã¦ã„ã‚‹ã‹ï¼ˆæœ¬ç•ªï¼‰
- Stripe CLIãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰
- Webhookç½²åã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒæ­£ã—ã„ã‹

**ãƒ­ã‚°ç¢ºèª:**

```bash
# Stripeãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ > Developers > Webhooks > ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°
# å„ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç¢ºèª
```

#### 2. ã‚µãƒ–ã‚¹ã‚¯ãŒåæ˜ ã•ã‚Œãªã„å ´åˆ

**ç¢ºèªãƒã‚¤ãƒ³ãƒˆ:**

- WebhookãŒæ­£å¸¸ã«å‡¦ç†ã•ã‚ŒãŸã‹
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®RLSãƒãƒªã‚·ãƒ¼ãŒæ­£ã—ã„ã‹
- `subscriptions`ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã‹

**SQLç¢ºèª:**

```sql
SELECT * FROM subscriptions WHERE user_id = 'xxx';
```

#### 3. åˆ¶é™ãƒã‚§ãƒƒã‚¯ãŒå‹•ä½œã—ãªã„å ´åˆ

**ç¢ºèªãƒã‚¤ãƒ³ãƒˆ:**

- `plan_limits`ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒå…¥ã£ã¦ã„ã‚‹ã‹
- ãƒ—ãƒ©ãƒ³å–å¾—ãƒ­ã‚¸ãƒƒã‚¯ãŒæ­£ã—ã„ã‹
- ãƒ•ãƒªãƒ¼ãƒ—ãƒ©ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š

---

### ğŸ“Š ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

#### é‡è¦ãªæŒ‡æ¨™

**ãƒ“ã‚¸ãƒã‚¹æŒ‡æ¨™:**

- æ–°è¦ã‚µãƒ–ã‚¹ã‚¯æ•°/æœˆ
- è§£ç´„ç‡ï¼ˆChurn Rateï¼‰
- å¹³å‡é¡§å®¢å˜ä¾¡ï¼ˆARPUï¼‰
- é¡§å®¢ç”Ÿæ¶¯ä¾¡å€¤ï¼ˆLTVï¼‰

**æŠ€è¡“æŒ‡æ¨™:**

- Webhookå‡¦ç†ã®æˆåŠŸç‡
- APIå¿œç­”æ™‚é–“
- ã‚¨ãƒ©ãƒ¼ç‡
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

#### ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š

- Webhookå‡¦ç†å¤±æ•—ç‡ãŒ5%ã‚’è¶…ãˆãŸå ´åˆ
- æ”¯æ‰•ã„å¤±æ•—ç‡ãŒ10%ã‚’è¶…ãˆãŸå ´åˆ
- APIå¿œç­”æ™‚é–“ãŒ3ç§’ã‚’è¶…ãˆãŸå ´åˆ

---

## ğŸ“š å‚è€ƒãƒªãƒ³ã‚¯

- [Stripeå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://stripe.com/docs)
- [Stripe Checkout](https://stripe.com/docs/payments/checkout)
- [Stripe Customer Portal](https://stripe.com/docs/billing/subscriptions/integrating-customer-portal)
- [Stripe Webhooks](https://stripe.com/docs/webhooks)
- [Stripe Testing](https://stripe.com/docs/testing)
- [Supabaseå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://supabase.com/docs)
- [ç‰¹å®šå•†å–å¼•æ³•ã‚¬ã‚¤ãƒ‰](https://www.no-trouble.caa.go.jp/)
- [å€‹äººæƒ…å ±ä¿è­·æ³•ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³](https://www.ppc.go.jp/)

---

